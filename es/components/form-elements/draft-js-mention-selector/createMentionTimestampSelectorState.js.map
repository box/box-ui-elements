{"version":3,"file":"createMentionTimestampSelectorState.js","names":["ContentState","EditorState","Modifier","SelectionState","DraftMentionDecorator","UNEDITABLE_TIMESTAMP_TEXT","convertMillisecondsToHMMSS","getMentionFromText","text","mentionRegex","matchArray","exec","fullMatch","triggerSymbol","id","name","start","index","end","length","data","content","getTimestampFromText","timestampRegex","match","timestamp","versionId","timestampInMilliseconds","parseInt","timestampToDisplay","indexOf","fileVersionId","processTimestampEntity","contentState","contentBlock","contentStateWithEntity","createEntity","timestampEntityKey","getLastCreatedEntityKey","timestampRange","createEmpty","getKey","merge","anchorOffset","focusOffset","replaceText","createMentionTimestampSelectorState","message","createFromText","getFirstBlock","getText","mention","getBlockForKey","mentionEntityKey","mentionRange","getBlockAfter","createWithContent"],"sources":["../../../../src/components/form-elements/draft-js-mention-selector/createMentionTimestampSelectorState.js"],"sourcesContent":["// @flow\nimport { ContentState, EditorState, Modifier, SelectionState } from 'draft-js';\nimport DraftMentionDecorator from './DraftMentionDecorator';\nimport { UNEDITABLE_TIMESTAMP_TEXT } from './utils';\nimport { convertMillisecondsToHMMSS } from '../../../utils/timestamp';\n\ntype timestampData = {\n    timestampInMilliseconds: number,\n    fileVersionId: string,\n    content: string,\n};\n\ntype mentionData = {\n    id: string,\n    name: string,\n    content: string,\n};\n\ntype timestampResult = {\n    start: number,\n    end: number,\n    data: timestampData,\n} | null;\n\ntype mentionResult = {\n    start: number,\n    end: number,\n    data: mentionData,\n} | null;\n\n// returns data for first mention in a string\nconst getMentionFromText = (text: string): mentionResult => {\n    // RegEx.exec() is stateful, so we create a new regex instance each time\n    const mentionRegex = /([@＠﹫])\\[(\\d+):([^\\]]+)]/gi;\n    const matchArray = mentionRegex.exec(text);\n    if (!matchArray) {\n        return null;\n    }\n    const [fullMatch, triggerSymbol, id, name] = matchArray;\n    const start = matchArray.index;\n    const end = start + fullMatch.length;\n    const data = { id, name, content: `${triggerSymbol}${name}` };\n    return { start, end, data };\n};\n\nconst getTimestampFromText = (text: string): timestampResult => {\n    const timestampRegex = /#\\[timestamp:(\\d+),versionId:(\\d+)\\]/;\n    const matchArray = text.match(timestampRegex);\n    if (!matchArray) {\n        return null;\n    }\n    const [fullMatch, timestamp, versionId] = matchArray;\n\n    const timestampInMilliseconds = parseInt(timestamp, 10);\n    const timestampToDisplay = convertMillisecondsToHMMSS(timestampInMilliseconds);\n    const start = text.indexOf(fullMatch);\n    const end = start + fullMatch.length;\n    const data = {\n        timestampInMilliseconds,\n        fileVersionId: versionId,\n        content: timestampToDisplay,\n    };\n    return { start, end, data };\n};\n\n// processes timestamp entity and updates content state\nconst processTimestampEntity = (\n    contentState: ContentState,\n    contentBlock: any,\n    timestamp: timestampResult,\n): ContentState => {\n    if (!timestamp) {\n        return contentState;\n    }\n    const { data, start, end } = timestamp;\n    const contentStateWithEntity = contentState.createEntity(UNEDITABLE_TIMESTAMP_TEXT, 'IMMUTABLE', data);\n    const timestampEntityKey = contentStateWithEntity.getLastCreatedEntityKey();\n    const timestampRange = SelectionState.createEmpty(contentBlock.getKey()).merge({\n        anchorOffset: start,\n        focusOffset: end,\n    });\n    return Modifier.replaceText(contentStateWithEntity, timestampRange, data.content, null, timestampEntityKey);\n};\n\n// creates draftjs state with mentions parsed into entities\nconst createMentionTimestampSelectorState = (message: string = ''): EditorState => {\n    let contentState = ContentState.createFromText(message);\n    let contentBlock = contentState.getFirstBlock();\n\n    while (contentBlock != null) {\n        const text = contentBlock.getText();\n        const mention = text ? getMentionFromText(text) : null;\n        const timestamp = text ? getTimestampFromText(text) : null;\n\n        // Process timestamp if present\n        if (timestamp) {\n            contentState = processTimestampEntity(contentState, contentBlock, timestamp);\n            contentBlock = contentState.getBlockForKey(contentBlock.getKey());\n        } else if (mention) {\n            const { data, start, end } = mention;\n            contentState.createEntity('MENTION', 'IMMUTABLE', data);\n            const mentionEntityKey = contentState.getLastCreatedEntityKey();\n            const mentionRange = SelectionState.createEmpty(contentBlock.getKey()).merge({\n                anchorOffset: start,\n                focusOffset: end,\n            });\n            contentState = Modifier.replaceText(contentState, mentionRange, data.content, null, mentionEntityKey);\n            contentBlock = contentState.getBlockForKey(contentBlock.getKey());\n        } else if (!timestamp && !mention) {\n            // No mention found, move to next block\n            contentBlock = contentState.getBlockAfter(contentBlock.getKey());\n        }\n    }\n    return EditorState.createWithContent(contentState, DraftMentionDecorator);\n};\n\nexport default createMentionTimestampSelectorState;\n"],"mappings":"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","ignoreList":[]}