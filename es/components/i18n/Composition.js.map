{"version":3,"file":"Composition.js","names":["React","JSTYPE_BOOLEAN","JSTYPE_NUMBER","JSTYPE_OBJECT","JSTYPE_STRING","MessageAccumulator","require","default","Node","Composition","constructor","element","isComposed","ma","keyIndex","recompose","Array","isArray","forEach","subelement","type","name","addParam","push","Children","props","children","child","pop","addText","String","compose","index","getMinimalString","nextKey","result","mapToReactElements","node","i","length","el","extra","temp","cloneElement","key","value","decompose","string","translation","create","nodeArray","use","concat","getPrefix","root","toArray","slice","getSuffix","fromArray"],"sources":["../../../src/components/i18n/Composition.js"],"sourcesContent":["/*\n * Utility class for the FormattedCompMessage component.\n */\nimport * as React from 'react';\nimport { JSTYPE_BOOLEAN, JSTYPE_NUMBER, JSTYPE_OBJECT, JSTYPE_STRING } from './constants';\n\nconst MessageAccumulator = require('message-accumulator').default; // ES5 CommonJS module\nconst Node = require('ilib-tree-node').default; // ES5 CommonJS module\n\n/**\n * @class Compose a tree of React elements into a single string.\n *\n * @param {React.Element} element the element to compose\n */\nclass Composition {\n    constructor(element) {\n        this.element = element;\n        this.isComposed = false;\n\n        this.ma = new MessageAccumulator();\n        this.keyIndex = 0;\n    }\n\n    recompose(element) {\n        switch (typeof element) {\n            case JSTYPE_OBJECT:\n                if (Array.isArray(element)) {\n                    element.forEach(subelement => this.recompose(subelement));\n                } else if (element) {\n                    if (element.type === 'Param' || element.type.name === 'Param') {\n                        this.ma.addParam(element);\n                    } else {\n                        this.ma.push(element);\n                        React.Children.forEach(element.props.children, child => this.recompose(child));\n                        this.ma.pop();\n                    }\n                }\n                break;\n\n            case JSTYPE_NUMBER:\n            case JSTYPE_BOOLEAN:\n                this.ma.addText(String(element));\n                break;\n\n            case JSTYPE_STRING:\n                this.ma.addText(element);\n                break;\n\n            default:\n                break;\n        }\n    }\n\n    /**\n     * Compose a tree of react elements to a string that can be translated.\n     *\n     * @return {string} a string representing the tree of react elements\n     */\n    compose() {\n        this.index = 0;\n        if (!this.isComposed) {\n            this.recompose(this.element);\n        }\n        this.isComposed = true;\n        return this.ma.getMinimalString();\n    }\n\n    /**\n     * @private\n     */\n    nextKey() {\n        const result = `key${this.keyIndex}`;\n        this.keyIndex += 1;\n        return result;\n    }\n\n    /**\n     * @private\n     */\n    mapToReactElements(node) {\n        if (!node) return '';\n\n        let children = [];\n        for (let i = 0; i < node.children.length; i += 1) {\n            children.push(this.mapToReactElements(node.children[i]));\n        }\n\n        const el = node.extra;\n        if (children.length === 0 && el && el.props) {\n            const { temp } = el.props;\n            children = temp;\n        }\n\n        if (children && children.length === 1 && typeof children[0] === 'string') {\n            [children] = children;\n        }\n\n        if (el) {\n            return children && children.length\n                ? React.cloneElement(el, { key: el.key || this.nextKey() }, children)\n                : React.cloneElement(el, { key: el.key || this.nextKey() });\n        }\n        if (children.length) {\n            return children.length > 1 ? children : children[0];\n        }\n\n        return node.value || '';\n    }\n\n    /**\n     * Convert a composed string back into an array of React elements. The elements are clones of\n     * the same ones that this composition was created with, so that they have the same type and\n     * props and such as the originals. The elements may be re-ordered from the original, however,\n     * if the grammar of the target language requires moving around text, HTML tags, or\n     * subcomponents.\n     *\n     * @param {string} string the string to decompose into a tree of React elements.\n     * @return {React.Element} a react element\n     */\n    decompose(string) {\n        if (!this.isComposed) {\n            // need to create the mapping first from names to react elements\n            this.compose();\n        }\n        const translation = MessageAccumulator.create(string, this.ma);\n        const nodeArray = [\n            new Node({\n                type: 'root',\n                use: 'start',\n            }),\n        ]\n            .concat(this.ma.getPrefix())\n            .concat(translation.root.toArray().slice(1, -1))\n            .concat(this.ma.getSuffix())\n            .concat([\n                new Node({\n                    type: 'root',\n                    use: 'end',\n                }),\n            ]);\n        // convert to a tree again\n        return this.mapToReactElements(Node.fromArray(nodeArray));\n    }\n}\n\nexport default Composition;\n"],"mappings":"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","ignoreList":[]}