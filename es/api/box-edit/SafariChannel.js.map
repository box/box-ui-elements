{"version":3,"file":"SafariChannel.js","names":["Channel","CONSTANTS","INPUT_EVENT","OUTPUT_EVENT","SafariChannel","constructor","appName","_defineProperty","operationType","data","browserToComServerTimeoutMS","comServerToApplicationTimeoutSec","Promise","resolve","reject","details","buildDetailsObj","timeoutId","setTimeout","Error","status_code","REQUEST_TIMEOUT_RESPONSE_CODE","reqIdToPromiseMap","set","req_id","rejectTimeout","createAndDispatchAppExtensionEvent","detail","isAppExtensionListenerAttached","document","addEventListener","appExtensionEventResponseHandler","removeEventListener","responseVal","response","JSON","parse","has","resolveObj","get","clearTimeout","delete","responseData","com_server_response","payload","CustomEvent","window","eventInstance","dispatchEvent","executeOperation","OPERATION_STATUS","OPERATION_REQUEST","OPERATION_COMMAND","tearDownSafariExtensionCommunication","Map","channelName","SAFARI_CHANNEL_NAME","setupSafariExtensionCommunication"],"sources":["../../../src/api/box-edit/SafariChannel.js"],"sourcesContent":["// @flow\nimport Channel from './Channel';\nimport CONSTANTS from './constants';\n\nconst INPUT_EVENT = 'box_extension_input';\nconst OUTPUT_EVENT = 'box_extension_output';\n\nclass SafariChannel extends Channel {\n    isAppExtensionListenerAttached: boolean;\n\n    reqIdToPromiseMap: Map<string, Object>;\n\n    window: any;\n\n    document: Document;\n\n    constructor(appName: string) {\n        super(appName);\n        this.reqIdToPromiseMap = new Map();\n        this.channelName = CONSTANTS.SAFARI_CHANNEL_NAME;\n        this.window = window;\n        this.document = document;\n        this.setupSafariExtensionCommunication();\n    }\n\n    executeOperation = (\n        operationType: string = '',\n        data: ?Object = {},\n        browserToComServerTimeoutMS: number = 0,\n        comServerToApplicationTimeoutSec: number = 0,\n    ): Promise<any> => {\n        return new Promise((resolve, reject) => {\n            const details = this.buildDetailsObj(operationType, data, comServerToApplicationTimeoutSec);\n\n            const timeoutId = setTimeout(() => {\n                reject(\n                    new Error({\n                        status_code: CONSTANTS.REQUEST_TIMEOUT_RESPONSE_CODE,\n                    }),\n                );\n            }, browserToComServerTimeoutMS);\n\n            this.reqIdToPromiseMap.set(details.req_id, {\n                resolve,\n                rejectTimeout: timeoutId,\n            });\n            this.createAndDispatchAppExtensionEvent({ detail: details });\n        });\n    };\n\n    setupSafariExtensionCommunication = () => {\n        if (!this.isAppExtensionListenerAttached) {\n            this.isAppExtensionListenerAttached = true;\n            this.document.addEventListener(OUTPUT_EVENT, this.appExtensionEventResponseHandler);\n        }\n    };\n\n    tearDownSafariExtensionCommunication = () => {\n        if (this.isAppExtensionListenerAttached) {\n            this.isAppExtensionListenerAttached = false;\n            this.document.removeEventListener(OUTPUT_EVENT, this.appExtensionEventResponseHandler);\n        }\n    };\n\n    appExtensionEventResponseHandler = (responseVal: any) => {\n        const response = typeof responseVal.detail === 'string' ? JSON.parse(responseVal.detail) : responseVal.detail;\n\n        if (this.reqIdToPromiseMap.has(response.req_id)) {\n            const resolveObj = this.reqIdToPromiseMap.get(response.req_id);\n            if (resolveObj) {\n                clearTimeout(resolveObj.rejectTimeout);\n                this.reqIdToPromiseMap.delete(response.req_id);\n\n                const responseData =\n                    typeof response.com_server_response.data === 'string'\n                        ? JSON.parse(response.com_server_response.data)\n                        : response.com_server_response.data;\n\n                resolveObj.resolve(responseData);\n            }\n        }\n    };\n\n    createAndDispatchAppExtensionEvent = (payload: Object) => {\n        const { CustomEvent } = this.window;\n\n        const eventInstance = new CustomEvent(INPUT_EVENT, payload);\n        this.document.dispatchEvent(eventInstance);\n    };\n\n    getComServerStatus = (browserToComServerTimeoutMS: number, comServerToApplicationTimeoutSec: number) => {\n        return this.executeOperation(\n            CONSTANTS.OPERATION_STATUS,\n            null,\n            browserToComServerTimeoutMS,\n            comServerToApplicationTimeoutSec,\n        );\n    };\n\n    sendRequest = (data: Object, browserToComServerTimeoutMS: number, comServerToApplicationTimeoutSec: number) => {\n        return this.executeOperation(\n            CONSTANTS.OPERATION_REQUEST,\n            data,\n            browserToComServerTimeoutMS,\n            comServerToApplicationTimeoutSec,\n        );\n    };\n\n    sendCommand = (data: Object, browserToComServerTimeoutMS: number, comServerToApplicationTimeoutSec: number) => {\n        return this.executeOperation(\n            CONSTANTS.OPERATION_COMMAND,\n            data,\n            browserToComServerTimeoutMS,\n            comServerToApplicationTimeoutSec,\n        );\n    };\n\n    destroy = () => {\n        this.tearDownSafariExtensionCommunication();\n    };\n}\n\nexport default SafariChannel;\n"],"mappings":"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","ignoreList":[]}