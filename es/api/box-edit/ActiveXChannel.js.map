{"version":3,"file":"ActiveXChannel.js","names":["Browser","Channel","CONSTANTS","MAX_RETRY_ATTEMPTS","ActiveXChannel","constructor","appName","isSynchronous","_defineProperty","operationType","data","browserToComServerTimeoutMS","comServerToApplicationTimeoutSec","Promise","resolve","reject","details","buildDetailsObj","timeoutId","setTimeout","Error","status_code","REQUEST_TIMEOUT_RESPONSE_CODE","reqIdToPromiseMap","set","req_id","rejectTimeout","executeActiveXEvent","detail","payload","isIEAndSpecificBrowserPluginSupported","BOX_TOOLS_PLUGIN_NAME","retryAttempt","activeX","createActiveXObjectJSRef","hasExecuteSyncAPI","ExecuteSync","JSON","stringify","Execute","ex","repairActiveXConnection","ActiveXObject","window","isActiveXExtensionListenerAttached","document","addEventListener","OUTPUT_EVENT","appExtensionEventResponseHandler","removeEventListener","responseVal","response","parse","has","resolveObj","get","clearTimeout","delete","responseData","com_server_response","executeOperation","OPERATION_STATUS","OPERATION_REQUEST","OPERATION_COMMAND","tearDownActiveXCommunication","channelName","ACTIVEX_CHANNEL_NAME","Map","setupActiveXCommunication"],"sources":["../../../src/api/box-edit/ActiveXChannel.js"],"sourcesContent":["// @flow\nimport Browser from './BrowserUtils';\nimport Channel from './Channel';\nimport CONSTANTS from './constants';\n\nconst MAX_RETRY_ATTEMPTS = 2;\n\nclass ActiveXChannel extends Channel {\n    isSynchronous: boolean;\n\n    isActiveXExtensionListenerAttached: boolean;\n\n    retryAttempt: number;\n\n    reqIdToPromiseMap: Map<string, Object>;\n\n    window: any;\n\n    document: Document;\n\n    constructor(appName: string, isSynchronous: boolean) {\n        super(appName);\n        this.isSynchronous = isSynchronous;\n        this.channelName = CONSTANTS.ACTIVEX_CHANNEL_NAME;\n        this.reqIdToPromiseMap = new Map();\n        this.isActiveXExtensionListenerAttached = false;\n        this.retryAttempt = 0;\n        this.document = document;\n        this.window = window;\n        this.setupActiveXCommunication();\n    }\n\n    executeOperation = (\n        operationType: string = '',\n        data: ?Object = {},\n        browserToComServerTimeoutMS: number = 0,\n        comServerToApplicationTimeoutSec: number = 0,\n    ): Promise<any> => {\n        return new Promise((resolve, reject) => {\n            const details = this.buildDetailsObj(operationType, data, comServerToApplicationTimeoutSec);\n\n            const timeoutId = setTimeout(() => {\n                reject(\n                    new Error({\n                        status_code: CONSTANTS.REQUEST_TIMEOUT_RESPONSE_CODE,\n                    }),\n                );\n            }, browserToComServerTimeoutMS);\n\n            this.reqIdToPromiseMap.set(details.req_id, {\n                resolve,\n                rejectTimeout: timeoutId,\n            });\n            this.executeActiveXEvent({ detail: details });\n        });\n    };\n\n    repairActiveXConnection = (payload: Object) => {\n        if (!Browser.isIEAndSpecificBrowserPluginSupported(CONSTANTS.BOX_TOOLS_PLUGIN_NAME)) {\n            return;\n        }\n\n        if (this.retryAttempt >= MAX_RETRY_ATTEMPTS) {\n            return;\n        }\n\n        this.retryAttempt += 1;\n\n        setTimeout(() => {\n            this.executeActiveXEvent(payload);\n        }, 100);\n    };\n\n    executeActiveXEvent = (payload: Object) => {\n        const activeX = this.createActiveXObjectJSRef();\n        const hasExecuteSyncAPI = 'ExecuteSync' in activeX;\n\n        try {\n            if (this.isSynchronous && hasExecuteSyncAPI) {\n                activeX.ExecuteSync(JSON.stringify(payload));\n            } else {\n                activeX.Execute(JSON.stringify(payload));\n            }\n        } catch (ex) {\n            this.repairActiveXConnection(payload);\n        }\n    };\n\n    createActiveXObjectJSRef = () => {\n        const { ActiveXObject } = this.window;\n        return new ActiveXObject(CONSTANTS.BOX_TOOLS_PLUGIN_NAME);\n    };\n\n    setupActiveXCommunication = () => {\n        if (!this.isActiveXExtensionListenerAttached) {\n            // attach the event listener to App Extension output events\n            this.document.addEventListener(CONSTANTS.OUTPUT_EVENT, this.appExtensionEventResponseHandler);\n            this.isActiveXExtensionListenerAttached = true;\n        }\n    };\n\n    tearDownActiveXCommunication = () => {\n        if (this.isActiveXExtensionListenerAttached) {\n            // remove the event listener for App Extension output events\n            this.document.removeEventListener(CONSTANTS.OUTPUT_EVENT, this.appExtensionEventResponseHandler);\n            this.isActiveXExtensionListenerAttached = false;\n        }\n    };\n\n    appExtensionEventResponseHandler = (responseVal: any) => {\n        if (this.retryAttempt > 0) {\n            this.retryAttempt = 0;\n        }\n\n        const response: Object =\n            typeof responseVal.detail === 'string' ? JSON.parse(responseVal.detail) : responseVal.detail;\n\n        if (this.reqIdToPromiseMap.has(response.req_id)) {\n            const resolveObj = this.reqIdToPromiseMap.get(response.req_id);\n            if (resolveObj) {\n                clearTimeout(resolveObj.rejectTimeout);\n                this.reqIdToPromiseMap.delete(response.req_id);\n\n                const responseData =\n                    typeof response.com_server_response.data === 'string'\n                        ? JSON.parse(response.com_server_response.data)\n                        : response.com_server_response.data;\n\n                resolveObj.resolve(responseData);\n            }\n        }\n    };\n\n    getComServerStatus = (browserToComServerTimeoutMS: number, comServerToApplicationTimeoutSec: number) => {\n        return this.executeOperation(\n            CONSTANTS.OPERATION_STATUS,\n            null,\n            browserToComServerTimeoutMS,\n            comServerToApplicationTimeoutSec,\n        );\n    };\n\n    sendRequest = (data: Object, browserToComServerTimeoutMS: number, comServerToApplicationTimeoutSec: number) => {\n        return this.executeOperation(\n            CONSTANTS.OPERATION_REQUEST,\n            data,\n            browserToComServerTimeoutMS,\n            comServerToApplicationTimeoutSec,\n        );\n    };\n\n    sendCommand = (data: Object, browserToComServerTimeoutMS: number, comServerToApplicationTimeoutSec: number) => {\n        return this.executeOperation(\n            CONSTANTS.OPERATION_COMMAND,\n            data,\n            browserToComServerTimeoutMS,\n            comServerToApplicationTimeoutSec,\n        );\n    };\n\n    destroy = () => {\n        this.tearDownActiveXCommunication();\n    };\n}\n\nexport { MAX_RETRY_ATTEMPTS };\nexport default ActiveXChannel;\n"],"mappings":"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","ignoreList":[]}