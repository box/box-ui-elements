{"version":3,"file":"Annotations.js","names":["merge","ERROR_CODE_CREATE_ANNOTATION","ERROR_CODE_CREATE_REPLY","ERROR_CODE_DELETE_ANNOTATION","ERROR_CODE_EDIT_ANNOTATION","ERROR_CODE_FETCH_ANNOTATION","ERROR_CODE_FETCH_ANNOTATIONS","ERROR_CODE_FETCH_REPLIES","PERMISSION_CAN_CREATE_ANNOTATIONS","PERMISSION_CAN_DELETE","PERMISSION_CAN_EDIT","PERMISSION_CAN_VIEW_ANNOTATIONS","PERMISSION_CAN_RESOLVE","MarkerBasedApi","formatComment","Annotations","constructor","args","_defineProperty","data","isDestroyed","successCallback","entries","type","formatReplies","length","replies","map","_objectSpread","annotations","annotation","getUrl","getBaseApiUrl","getUrlForId","annotationId","getUrlWithRepliesForId","createAnnotation","fileId","fileVersionId","payload","permissions","errorCallback","errorCode","checkApiCallValidity","e","defaults","description","file_version","id","post","url","updateAnnotation","message","status","put","undefined","deleteAnnotation","delete","getAnnotation","shouldFetchReplies","requestData","params","fields","get","getAnnotations","limit","shouldFetchAll","file_id","file_version_id","markerGet","getAnnotationReplies","createAnnotationReply"],"sources":["../../src/api/Annotations.js"],"sourcesContent":["// @flow\nimport merge from 'lodash/merge';\nimport {\n    ERROR_CODE_CREATE_ANNOTATION,\n    ERROR_CODE_CREATE_REPLY,\n    ERROR_CODE_DELETE_ANNOTATION,\n    ERROR_CODE_EDIT_ANNOTATION,\n    ERROR_CODE_FETCH_ANNOTATION,\n    ERROR_CODE_FETCH_ANNOTATIONS,\n    ERROR_CODE_FETCH_REPLIES,\n    PERMISSION_CAN_CREATE_ANNOTATIONS,\n    PERMISSION_CAN_DELETE,\n    PERMISSION_CAN_EDIT,\n    PERMISSION_CAN_VIEW_ANNOTATIONS,\n    PERMISSION_CAN_RESOLVE,\n} from '../constants';\nimport MarkerBasedApi from './MarkerBasedAPI';\nimport { formatComment } from './utils';\n\nimport type {\n    Annotation,\n    AnnotationPermission,\n    Annotations as AnnotationsType,\n    NewAnnotation,\n} from '../common/types/annotations';\nimport type { BoxItemPermission } from '../common/types/core';\nimport type { ElementsXhrError } from '../common/types/api';\nimport type { Comment, FeedItemStatus, ThreadedComments } from '../common/types/feed';\n\nexport default class Annotations extends MarkerBasedApi {\n    /**\n     * Formats annotation replies' comment data for use in components.\n     *\n     * @param {Annotation} annotation - An individual annotation entry from the API\n     * @return {Annotation} Updated annotation\n     */\n    formatReplies(annotation: Annotation): Annotation {\n        if (!annotation.replies || !annotation.replies.length) {\n            return annotation;\n        }\n\n        return {\n            ...annotation,\n            replies: annotation.replies.map(formatComment),\n        };\n    }\n\n    /**\n     * Formats the annotations api response to usable data\n     * @param {Object} data the api response data\n     */\n    successHandler = (data: Object): void => {\n        if (this.isDestroyed() || typeof this.successCallback !== 'function') {\n            return;\n        }\n\n        // There is no response data when deleting an annotation\n        if (!data) {\n            this.successCallback();\n            return;\n        }\n\n        // We don't have entries when updating/creating an annotation\n        if (!data.entries) {\n            // Check if the response is a comment (result of createAnnotationReply)\n            if (data.type && data.type === 'comment') {\n                this.successCallback(formatComment(data));\n                return;\n            }\n\n            this.successCallback(this.formatReplies(data));\n            return;\n        }\n\n        // Check if the response is the replies of an annotation (result of getAnnotationReplies)\n        if (data.entries.length && data.entries[0].type === 'comment') {\n            const replies = data.entries.map(formatComment);\n            this.successCallback({ ...data, entries: replies });\n            return;\n        }\n\n        const annotations = data.entries.map(this.formatReplies);\n        this.successCallback({ ...data, entries: annotations });\n    };\n\n    getUrl() {\n        return `${this.getBaseApiUrl()}/undoc/annotations`;\n    }\n\n    getUrlForId(annotationId: string) {\n        return `${this.getUrl()}/${annotationId}`;\n    }\n\n    getUrlWithRepliesForId(annotationId: string) {\n        return `${this.getUrlForId(annotationId)}/replies`;\n    }\n\n    createAnnotation(\n        fileId: string,\n        fileVersionId: string,\n        payload: NewAnnotation,\n        permissions: BoxItemPermission,\n        successCallback: (annotation: Annotation) => void,\n        errorCallback: (e: ElementsXhrError, code: string) => void,\n    ): void {\n        this.errorCode = ERROR_CODE_CREATE_ANNOTATION;\n\n        try {\n            this.checkApiCallValidity(PERMISSION_CAN_CREATE_ANNOTATIONS, permissions, fileId);\n        } catch (e) {\n            errorCallback(e, this.errorCode);\n            return;\n        }\n\n        const defaults = {\n            description: {\n                type: 'reply',\n            },\n            file_version: {\n                id: fileVersionId,\n                type: 'file_version',\n            },\n        };\n\n        this.post({\n            id: fileId,\n            data: {\n                data: merge(defaults, payload),\n            },\n            errorCallback,\n            successCallback,\n            url: this.getUrl(),\n        });\n    }\n\n    updateAnnotation(\n        fileId: string,\n        annotationId: string,\n        permissions: AnnotationPermission,\n        payload: { message?: string, status?: FeedItemStatus },\n        successCallback: (annotation: Annotation) => void,\n        errorCallback: (e: ElementsXhrError, code: string) => void,\n    ): void {\n        this.errorCode = ERROR_CODE_EDIT_ANNOTATION;\n        const { message, status } = payload;\n\n        if (message) {\n            try {\n                this.checkApiCallValidity(PERMISSION_CAN_EDIT, permissions, fileId);\n            } catch (e) {\n                errorCallback(e, this.errorCode);\n                return;\n            }\n        }\n\n        if (status) {\n            try {\n                this.checkApiCallValidity(PERMISSION_CAN_RESOLVE, permissions, fileId);\n            } catch (e) {\n                errorCallback(e, this.errorCode);\n                return;\n            }\n        }\n\n        this.put({\n            id: fileId,\n            data: {\n                data: {\n                    description: message ? { message } : undefined,\n                    status,\n                },\n            },\n            errorCallback,\n            successCallback,\n            url: this.getUrlForId(annotationId),\n        });\n    }\n\n    deleteAnnotation(\n        fileId: string,\n        annotationId: string,\n        permissions: AnnotationPermission,\n        successCallback: () => void,\n        errorCallback: (e: ElementsXhrError, code: string) => void,\n    ): void {\n        this.errorCode = ERROR_CODE_DELETE_ANNOTATION;\n\n        try {\n            this.checkApiCallValidity(PERMISSION_CAN_DELETE, permissions, fileId);\n        } catch (e) {\n            errorCallback(e, this.errorCode);\n            return;\n        }\n\n        this.delete({\n            id: fileId,\n            errorCallback,\n            successCallback,\n            url: this.getUrlForId(annotationId),\n        });\n    }\n\n    getAnnotation(\n        fileId: string,\n        annotationId: string,\n        permissions: BoxItemPermission,\n        successCallback: (annotation: Annotation) => void,\n        errorCallback: (e: ElementsXhrError, code: string) => void,\n        shouldFetchReplies?: boolean,\n    ): void {\n        this.errorCode = ERROR_CODE_FETCH_ANNOTATION;\n\n        try {\n            this.checkApiCallValidity(PERMISSION_CAN_VIEW_ANNOTATIONS, permissions, fileId);\n        } catch (e) {\n            errorCallback(e, this.errorCode);\n            return;\n        }\n\n        const requestData = shouldFetchReplies ? { params: { fields: 'replies' } } : undefined;\n\n        this.get({\n            id: fileId,\n            errorCallback,\n            successCallback,\n            url: this.getUrlForId(annotationId),\n            requestData,\n        });\n    }\n\n    getAnnotations(\n        fileId: string,\n        fileVersionId?: string,\n        permissions: BoxItemPermission,\n        successCallback: (annotations: AnnotationsType) => void,\n        errorCallback: (e: ElementsXhrError, code: string) => void,\n        limit?: number,\n        shouldFetchAll?: boolean,\n        shouldFetchReplies?: boolean,\n    ): void {\n        this.errorCode = ERROR_CODE_FETCH_ANNOTATIONS;\n\n        try {\n            this.checkApiCallValidity(PERMISSION_CAN_VIEW_ANNOTATIONS, permissions, fileId);\n        } catch (e) {\n            errorCallback(e, this.errorCode);\n            return;\n        }\n\n        const requestData = {\n            file_id: fileId,\n            file_version_id: fileVersionId,\n            ...(shouldFetchReplies ? { fields: 'replies' } : null),\n        };\n\n        this.markerGet({\n            id: fileId,\n            errorCallback,\n            limit,\n            requestData,\n            shouldFetchAll,\n            successCallback,\n        });\n    }\n\n    getAnnotationReplies(\n        fileId: string,\n        annotationId: string,\n        permissions: BoxItemPermission,\n        successCallback: (comments: ThreadedComments) => void,\n        errorCallback: (e: ElementsXhrError, code: string) => void,\n    ): void {\n        this.errorCode = ERROR_CODE_FETCH_REPLIES;\n\n        try {\n            this.checkApiCallValidity(PERMISSION_CAN_VIEW_ANNOTATIONS, permissions, fileId);\n        } catch (e) {\n            errorCallback(e, this.errorCode);\n            return;\n        }\n\n        this.get({\n            id: fileId,\n            errorCallback,\n            successCallback,\n            url: this.getUrlWithRepliesForId(annotationId),\n        });\n    }\n\n    createAnnotationReply(\n        fileId: string,\n        annotationId: string,\n        permissions: BoxItemPermission,\n        message: string,\n        successCallback: (comment: Comment) => void,\n        errorCallback: (e: ElementsXhrError, code: string) => void,\n    ): void {\n        this.errorCode = ERROR_CODE_CREATE_REPLY;\n\n        try {\n            this.checkApiCallValidity(PERMISSION_CAN_CREATE_ANNOTATIONS, permissions, fileId);\n        } catch (e) {\n            errorCallback(e, this.errorCode);\n            return;\n        }\n\n        this.post({\n            id: fileId,\n            data: { data: { message } },\n            errorCallback,\n            successCallback,\n            url: `${this.getUrlWithRepliesForId(annotationId)}?file_id=${fileId}`,\n        });\n    }\n}\n"],"mappings":";;;;;AACA,OAAOA,KAAK,MAAM,cAAc;AAChC,SACIC,4BAA4B,EAC5BC,uBAAuB,EACvBC,4BAA4B,EAC5BC,0BAA0B,EAC1BC,2BAA2B,EAC3BC,4BAA4B,EAC5BC,wBAAwB,EACxBC,iCAAiC,EACjCC,qBAAqB,EACrBC,mBAAmB,EACnBC,+BAA+B,EAC/BC,sBAAsB,QACnB,cAAc;AACrB,OAAOC,cAAc,MAAM,kBAAkB;AAC7C,SAASC,aAAa,QAAQ,SAAS;AAYvC,eAAe,MAAMC,WAAW,SAASF,cAAc,CAAC;EAAAG,YAAA,GAAAC,IAAA;IAAA,SAAAA,IAAA;IAkBpD;AACJ;AACA;AACA;IAHIC,eAAA,yBAIkBC,IAAY,IAAW;MACrC,IAAI,IAAI,CAACC,WAAW,CAAC,CAAC,IAAI,OAAO,IAAI,CAACC,eAAe,KAAK,UAAU,EAAE;QAClE;MACJ;;MAEA;MACA,IAAI,CAACF,IAAI,EAAE;QACP,IAAI,CAACE,eAAe,CAAC,CAAC;QACtB;MACJ;;MAEA;MACA,IAAI,CAACF,IAAI,CAACG,OAAO,EAAE;QACf;QACA,IAAIH,IAAI,CAACI,IAAI,IAAIJ,IAAI,CAACI,IAAI,KAAK,SAAS,EAAE;UACtC,IAAI,CAACF,eAAe,CAACP,aAAa,CAACK,IAAI,CAAC,CAAC;UACzC;QACJ;QAEA,IAAI,CAACE,eAAe,CAAC,IAAI,CAACG,aAAa,CAACL,IAAI,CAAC,CAAC;QAC9C;MACJ;;MAEA;MACA,IAAIA,IAAI,CAACG,OAAO,CAACG,MAAM,IAAIN,IAAI,CAACG,OAAO,CAAC,CAAC,CAAC,CAACC,IAAI,KAAK,SAAS,EAAE;QAC3D,MAAMG,OAAO,GAAGP,IAAI,CAACG,OAAO,CAACK,GAAG,CAACb,aAAa,CAAC;QAC/C,IAAI,CAACO,eAAe,CAAAO,aAAA,CAAAA,aAAA,KAAMT,IAAI;UAAEG,OAAO,EAAEI;QAAO,EAAE,CAAC;QACnD;MACJ;MAEA,MAAMG,WAAW,GAAGV,IAAI,CAACG,OAAO,CAACK,GAAG,CAAC,IAAI,CAACH,aAAa,CAAC;MACxD,IAAI,CAACH,eAAe,CAAAO,aAAA,CAAAA,aAAA,KAAMT,IAAI;QAAEG,OAAO,EAAEO;MAAW,EAAE,CAAC;IAC3D,CAAC;EAAA;EArDD;AACJ;AACA;AACA;AACA;AACA;EACIL,aAAaA,CAACM,UAAsB,EAAc;IAC9C,IAAI,CAACA,UAAU,CAACJ,OAAO,IAAI,CAACI,UAAU,CAACJ,OAAO,CAACD,MAAM,EAAE;MACnD,OAAOK,UAAU;IACrB;IAEA,OAAAF,aAAA,CAAAA,aAAA,KACOE,UAAU;MACbJ,OAAO,EAAEI,UAAU,CAACJ,OAAO,CAACC,GAAG,CAACb,aAAa;IAAC;EAEtD;EAwCAiB,MAAMA,CAAA,EAAG;IACL,OAAO,GAAG,IAAI,CAACC,aAAa,CAAC,CAAC,oBAAoB;EACtD;EAEAC,WAAWA,CAACC,YAAoB,EAAE;IAC9B,OAAO,GAAG,IAAI,CAACH,MAAM,CAAC,CAAC,IAAIG,YAAY,EAAE;EAC7C;EAEAC,sBAAsBA,CAACD,YAAoB,EAAE;IACzC,OAAO,GAAG,IAAI,CAACD,WAAW,CAACC,YAAY,CAAC,UAAU;EACtD;EAEAE,gBAAgBA,CACZC,MAAc,EACdC,aAAqB,EACrBC,OAAsB,EACtBC,WAA8B,EAC9BnB,eAAiD,EACjDoB,aAA0D,EACtD;IACJ,IAAI,CAACC,SAAS,GAAGzC,4BAA4B;IAE7C,IAAI;MACA,IAAI,CAAC0C,oBAAoB,CAACnC,iCAAiC,EAAEgC,WAAW,EAAEH,MAAM,CAAC;IACrF,CAAC,CAAC,OAAOO,CAAC,EAAE;MACRH,aAAa,CAACG,CAAC,EAAE,IAAI,CAACF,SAAS,CAAC;MAChC;IACJ;IAEA,MAAMG,QAAQ,GAAG;MACbC,WAAW,EAAE;QACTvB,IAAI,EAAE;MACV,CAAC;MACDwB,YAAY,EAAE;QACVC,EAAE,EAAEV,aAAa;QACjBf,IAAI,EAAE;MACV;IACJ,CAAC;IAED,IAAI,CAAC0B,IAAI,CAAC;MACND,EAAE,EAAEX,MAAM;MACVlB,IAAI,EAAE;QACFA,IAAI,EAAEnB,KAAK,CAAC6C,QAAQ,EAAEN,OAAO;MACjC,CAAC;MACDE,aAAa;MACbpB,eAAe;MACf6B,GAAG,EAAE,IAAI,CAACnB,MAAM,CAAC;IACrB,CAAC,CAAC;EACN;EAEAoB,gBAAgBA,CACZd,MAAc,EACdH,YAAoB,EACpBM,WAAiC,EACjCD,OAAsD,EACtDlB,eAAiD,EACjDoB,aAA0D,EACtD;IACJ,IAAI,CAACC,SAAS,GAAGtC,0BAA0B;IAC3C,MAAM;MAAEgD,OAAO;MAAEC;IAAO,CAAC,GAAGd,OAAO;IAEnC,IAAIa,OAAO,EAAE;MACT,IAAI;QACA,IAAI,CAACT,oBAAoB,CAACjC,mBAAmB,EAAE8B,WAAW,EAAEH,MAAM,CAAC;MACvE,CAAC,CAAC,OAAOO,CAAC,EAAE;QACRH,aAAa,CAACG,CAAC,EAAE,IAAI,CAACF,SAAS,CAAC;QAChC;MACJ;IACJ;IAEA,IAAIW,MAAM,EAAE;MACR,IAAI;QACA,IAAI,CAACV,oBAAoB,CAAC/B,sBAAsB,EAAE4B,WAAW,EAAEH,MAAM,CAAC;MAC1E,CAAC,CAAC,OAAOO,CAAC,EAAE;QACRH,aAAa,CAACG,CAAC,EAAE,IAAI,CAACF,SAAS,CAAC;QAChC;MACJ;IACJ;IAEA,IAAI,CAACY,GAAG,CAAC;MACLN,EAAE,EAAEX,MAAM;MACVlB,IAAI,EAAE;QACFA,IAAI,EAAE;UACF2B,WAAW,EAAEM,OAAO,GAAG;YAAEA;UAAQ,CAAC,GAAGG,SAAS;UAC9CF;QACJ;MACJ,CAAC;MACDZ,aAAa;MACbpB,eAAe;MACf6B,GAAG,EAAE,IAAI,CAACjB,WAAW,CAACC,YAAY;IACtC,CAAC,CAAC;EACN;EAEAsB,gBAAgBA,CACZnB,MAAc,EACdH,YAAoB,EACpBM,WAAiC,EACjCnB,eAA2B,EAC3BoB,aAA0D,EACtD;IACJ,IAAI,CAACC,SAAS,GAAGvC,4BAA4B;IAE7C,IAAI;MACA,IAAI,CAACwC,oBAAoB,CAAClC,qBAAqB,EAAE+B,WAAW,EAAEH,MAAM,CAAC;IACzE,CAAC,CAAC,OAAOO,CAAC,EAAE;MACRH,aAAa,CAACG,CAAC,EAAE,IAAI,CAACF,SAAS,CAAC;MAChC;IACJ;IAEA,IAAI,CAACe,MAAM,CAAC;MACRT,EAAE,EAAEX,MAAM;MACVI,aAAa;MACbpB,eAAe;MACf6B,GAAG,EAAE,IAAI,CAACjB,WAAW,CAACC,YAAY;IACtC,CAAC,CAAC;EACN;EAEAwB,aAAaA,CACTrB,MAAc,EACdH,YAAoB,EACpBM,WAA8B,EAC9BnB,eAAiD,EACjDoB,aAA0D,EAC1DkB,kBAA4B,EACxB;IACJ,IAAI,CAACjB,SAAS,GAAGrC,2BAA2B;IAE5C,IAAI;MACA,IAAI,CAACsC,oBAAoB,CAAChC,+BAA+B,EAAE6B,WAAW,EAAEH,MAAM,CAAC;IACnF,CAAC,CAAC,OAAOO,CAAC,EAAE;MACRH,aAAa,CAACG,CAAC,EAAE,IAAI,CAACF,SAAS,CAAC;MAChC;IACJ;IAEA,MAAMkB,WAAW,GAAGD,kBAAkB,GAAG;MAAEE,MAAM,EAAE;QAAEC,MAAM,EAAE;MAAU;IAAE,CAAC,GAAGP,SAAS;IAEtF,IAAI,CAACQ,GAAG,CAAC;MACLf,EAAE,EAAEX,MAAM;MACVI,aAAa;MACbpB,eAAe;MACf6B,GAAG,EAAE,IAAI,CAACjB,WAAW,CAACC,YAAY,CAAC;MACnC0B;IACJ,CAAC,CAAC;EACN;EAEAI,cAAcA,CACV3B,MAAc,EACdC,aAAsB,EACtBE,WAA8B,EAC9BnB,eAAuD,EACvDoB,aAA0D,EAC1DwB,KAAc,EACdC,cAAwB,EACxBP,kBAA4B,EACxB;IACJ,IAAI,CAACjB,SAAS,GAAGpC,4BAA4B;IAE7C,IAAI;MACA,IAAI,CAACqC,oBAAoB,CAAChC,+BAA+B,EAAE6B,WAAW,EAAEH,MAAM,CAAC;IACnF,CAAC,CAAC,OAAOO,CAAC,EAAE;MACRH,aAAa,CAACG,CAAC,EAAE,IAAI,CAACF,SAAS,CAAC;MAChC;IACJ;IAEA,MAAMkB,WAAW,GAAAhC,aAAA;MACbuC,OAAO,EAAE9B,MAAM;MACf+B,eAAe,EAAE9B;IAAa,GAC1BqB,kBAAkB,GAAG;MAAEG,MAAM,EAAE;IAAU,CAAC,GAAG,IAAI,CACxD;IAED,IAAI,CAACO,SAAS,CAAC;MACXrB,EAAE,EAAEX,MAAM;MACVI,aAAa;MACbwB,KAAK;MACLL,WAAW;MACXM,cAAc;MACd7C;IACJ,CAAC,CAAC;EACN;EAEAiD,oBAAoBA,CAChBjC,MAAc,EACdH,YAAoB,EACpBM,WAA8B,EAC9BnB,eAAqD,EACrDoB,aAA0D,EACtD;IACJ,IAAI,CAACC,SAAS,GAAGnC,wBAAwB;IAEzC,IAAI;MACA,IAAI,CAACoC,oBAAoB,CAAChC,+BAA+B,EAAE6B,WAAW,EAAEH,MAAM,CAAC;IACnF,CAAC,CAAC,OAAOO,CAAC,EAAE;MACRH,aAAa,CAACG,CAAC,EAAE,IAAI,CAACF,SAAS,CAAC;MAChC;IACJ;IAEA,IAAI,CAACqB,GAAG,CAAC;MACLf,EAAE,EAAEX,MAAM;MACVI,aAAa;MACbpB,eAAe;MACf6B,GAAG,EAAE,IAAI,CAACf,sBAAsB,CAACD,YAAY;IACjD,CAAC,CAAC;EACN;EAEAqC,qBAAqBA,CACjBlC,MAAc,EACdH,YAAoB,EACpBM,WAA8B,EAC9BY,OAAe,EACf/B,eAA2C,EAC3CoB,aAA0D,EACtD;IACJ,IAAI,CAACC,SAAS,GAAGxC,uBAAuB;IAExC,IAAI;MACA,IAAI,CAACyC,oBAAoB,CAACnC,iCAAiC,EAAEgC,WAAW,EAAEH,MAAM,CAAC;IACrF,CAAC,CAAC,OAAOO,CAAC,EAAE;MACRH,aAAa,CAACG,CAAC,EAAE,IAAI,CAACF,SAAS,CAAC;MAChC;IACJ;IAEA,IAAI,CAACO,IAAI,CAAC;MACND,EAAE,EAAEX,MAAM;MACVlB,IAAI,EAAE;QAAEA,IAAI,EAAE;UAAEiC;QAAQ;MAAE,CAAC;MAC3BX,aAAa;MACbpB,eAAe;MACf6B,GAAG,EAAE,GAAG,IAAI,CAACf,sBAAsB,CAACD,YAAY,CAAC,YAAYG,MAAM;IACvE,CAAC,CAAC;EACN;AACJ","ignoreList":[]}